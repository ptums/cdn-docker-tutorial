# ~/localcdn/loadbalancer/nginx.conf

events { }

http {
    # ── Define the two edge backends in a round‑robin group ────────────────
    upstream edges {
        # The name “edges” is our pool of backend servers
        server edge-us.local:80;
        server edge-eu.local:80;
    }

    # ─── UPDATED: API upstream ────────────────────────────────────────
    upstream apis {
        # point at the API container by name on the Docker network
        server api:4000;
    }

    server {
        # Listen on HTTP port 80 inside the container
        listen 80;
        server_name lb.local;

 
        location / {
            # forward the request to one of the edges
            proxy_pass http://edges;

            # pass through the Host header so caching still works
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # add the upstream address into the response headers
            add_header X-Backend-Server $upstream_addr;
        }

        # ─── NEW: proxy API calls ───────────────────────────────────
        location /api/ {
            proxy_pass http://apis;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            add_header X-API-Backend $upstream_addr;
        }
    }
}